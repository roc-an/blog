# 从浏览器地址栏中输入 URL 到看到页面，中间经历了什么？

## （一）概述

这是一道非常综合的面试题，内容涉及了操作系统、浏览器底层原理、网络通信以及页面渲染相关的知识，可以考察应聘者的技术视野和技术深度。

另外抛开面试不谈，如果能够理解从输入 URL 到页面渲染完成的整个过程细节，对于我们进行 Web 性能优化、问题定位都是非常有帮助的，可以让我们站在更高的角度去看待自己写的代码。

这篇文章会对详细流程进行分析，并对涉及到的相关知识进行较详细的讲解。

无论是输入 URL，或是进行网络请求，还是渲染页面，进行这些操作的都是浏览器。现代浏览器采用的都是**多进程架构**，不同进程负责不同的事情，要想把整体流程理解透彻，首先要搞清楚浏览器中有哪些进程，分别负责处理什么事情。

## （二）浏览器的多进程架构

### 线程的并行处理执行

先从线程说起，**线程（Thread）是操作系统能够进行运算调度的最小单位**。也就是说，如果我们的电脑要执行某项任务，没有比线程更小的拆分粒度了。

那么问题来了，执行一项任务，大任务可以拆分成小任务给不同的线程去执行，那线程可以并行处理任务吗？如果可以，那不就能大大缩短执行这个大任务的时间咯？

答案是可以的，**线程可以并行处理任务**。

比如下面这 3 行代码就包含了 3 个要处理的小任务：

```js
let a = 1 + 2; // 任务1：计算 1 + 2 的值，赋值给变量 a
let b = 3 / 3; // 任务2：计算 3 / 3 的值，赋值给变量 b
console.log(a, b); // 任务3：浏览器控制台打印变量 a 和 b 的值
```

如果用**单线程**来处理，需要 3 步，即一个线程依次执行上面的 3 行代码。

但如果用**多线程**来处理，仅需要 2 步：

1. 使用 2 个线程，分别执行任务 1 和任务 2，得到赋值后的变量 a 和变量 b
2. 使用 1 个线程，执行任务 3，打印变量

所以，**线程的并行处理执行可以大大提升性能。**

### 进程负责线程的调度

但是线程多起来了以后，由谁管理呢？这就要说到进程了。

**一个进程（Process）就是操作系统中一个应用程序的运行实例，进程包含多个线程，负责线程的启动和调度，可以支持线程的并行处理执行。**

上面多线程并行处理的代码，如果用图来表示，就是这样：

**进程和线程的关系：**

**1.只要进程中任一线程执行出错，都会导致整个进程崩溃**

比如，如果把之前的 3 行代码改成这样：

```js
let a = 1 + 2; // 任务1：计算 1 + 2 的值，赋值给变量 a
let b = c / 3; // 任务2：计算 c / 3 的值，赋值给变量 b
console.log(a, b); // 任务3：浏览器控制台打印变量 a 和 b 的值
```

在执行任务 2 时，由于找不到变量 `c`，于是执行出错，一旦出错，整个进程也就崩溃了，就轮不到线程再去执行任务 3 了。

**2.线程之间共享进程中的资源**

上图任务执行过程中需要进行变量的赋值/取值操作，也就是数据的写和读，这些数据在进程中是可以被各个线程所共享访问的。

注意，“共享访问”并不意味着“同时访问”，如果同时有好多线程对同一个数据进行读写，那不就乱套了。

于是线程中存在一个叫**互斥锁（Mutex）**的东西。好比在旅游景点想去上个厕所，进去后把锁锁上（Lock），这样其他人再想用厕所就只能外边等着，等上完厕所出来，再把锁解开（Unlock），这样其他人又能接着用了。例子有点糙，不过道理确实是这么个道理。

**3.进程关闭后，操作系统会回收进程占用的内存**

无论进程是正常退出，还是因为线程执行出错而意外崩溃，系统都会对进程执行过程中申请的内存进行回收。如果没有这个机制，内存就会越用越多，最终被用光。

有时候我们打游戏，由于程序写的不好，系统越玩越卡，但一旦关了以后，一切又都好起来了，就是这个道理。

**4.进程间相互隔离**

一般情况下，一个进程只能访问自己的数据，这样做是为了避免进程间互相干扰。一个进程崩溃了，又导致其他进程跟着崩溃，那岂不控制不住了，所以操作系统才会有**进程隔离**的机制。

当然，进程间是允许进行数据交互的，这就要用到 IPC（Inter-Process Communication，进程间通信）了。
